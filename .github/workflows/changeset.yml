name: Changeset Management

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  verify-changeset:
    name: Verify Changeset
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.pull_request.labels.*.name, 'no-changeset') &&
      !contains(github.event.pull_request.labels.*.name, 'dependencies')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Check for Changeset
        id: check
        run: |
          if [ -z "$(ls -A .changeset/*.md 2>/dev/null | grep -v README)" ]; then
            echo "has-changeset=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No changeset found"
          else
            echo "has-changeset=true" >> $GITHUB_OUTPUT
            echo "âœ… Changeset found"
          fi

      - name: Comment on PR - Missing Changeset
        if: steps.check.outputs.has-changeset == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âš ï¸ No Changeset Found

            This PR doesn't include a changeset. If this PR includes user-facing changes, please add a changeset:

            \`\`\`bash
            pnpm changeset
            \`\`\`

            Then follow the prompts to:
            1. Select packages to include
            2. Choose version bump type (major, minor, patch)
            3. Write a summary of changes

            If this PR doesn't require a changeset (e.g., docs, tests, internal changes), add the \`no-changeset\` label.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on PR - Changeset Found
        if: steps.check.outputs.has-changeset == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âœ… Changeset Detected

            This PR includes a changeset. The following packages will be updated when this PR is merged.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  changeset-status:
    name: Changeset Status
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch main branch
        run: |
          git fetch origin main:main
          git branch -a

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Changeset Status
        run: |
          pnpm changeset status --verbose

          echo "## ðŸ“ Changeset Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pnpm changeset status --output=/tmp/changeset-status.json || true
          if [ -f /tmp/changeset-status.json ]; then
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat /tmp/changeset-status.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  validate-changeset-format:
    name: Validate Changeset Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Changeset Files
        run: |
          echo "## ðŸ” Changeset Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in .changeset/*.md; do
            if [ "$file" != ".changeset/README.md" ] && [ -f "$file" ]; then
              echo "Validating $file..." >> $GITHUB_STEP_SUMMARY
              
              # Check if file has proper frontmatter
              if ! grep -q "^---$" "$file"; then
                echo "âŒ $file: Missing frontmatter" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
              
              echo "âœ… $file: Valid format" >> $GITHUB_STEP_SUMMARY
            fi
          done
